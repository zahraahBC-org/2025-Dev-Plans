# 11. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ±ÙŠØ¯ | Procurement System
## Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ | Supplier Management and Purchase Orders

### ğŸ“‹ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© | Document Information**

**Ø§Ù„Ù‡Ø¯Ù**: ØªØ­Ø¯ÙŠØ¯ Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ±ÙŠØ¯  
**Purpose**: Define complete procurement and inbound management system

**Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±**: Ù…Ø¯ÙŠØ±Ùˆ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§ØªØŒ ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙˆÙ†  
**Audience**: Procurement managers, inventory team, accountants

**Ø§Ù„Ù†Ø·Ø§Ù‚**: Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŒ Landed Cost  
**Scope**: Suppliers, purchase orders, receiving, landed cost

---

## ğŸ¯ **Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© | Overview**

Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠÙˆÙØ± Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¥Ù„Ù‰ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹ ÙˆØ¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©.

**Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©**:
- âœ… ØªØ£Ù…ÙŠÙ† ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
- âœ… ØªØªØ¨Ø¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
- âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Landed Cost
- âœ… Ù‚ÙŠØ§Ø³ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
- âœ… ØªÙ‚Ù„ÙŠÙ„ Ù†ÙØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Stockouts

---

## ğŸ“‘ **Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª | Table of Contents**

1. [Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† | Supplier Management](#supplier-management)
2. [Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ PO | Purchase Orders](#purchase-orders)
3. [Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ASN | Inbound Shipments](#inbound-shipments)
4. [Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ÙØ­Øµ GRN | Goods Receipt](#goods-receipt)
5. [Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Landed Cost | Landed Cost](#landed-cost)
6. [Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø«Ù„Ø§Ø«ÙŠØ© | 3-Way Matching](#three-way-matching)
7. [Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† RTV | Return to Vendor](#return-to-vendor)
8. [Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ | Reorder Rules](#reorder-rules)

---

## 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† | Supplier Management {#supplier-management}

### **Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† | Suppliers Table**

```sql
CREATE TABLE suppliers (
    supplier_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    supplier_code VARCHAR(50) UNIQUE NOT NULL,
    
    -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
    name_ar VARCHAR(255) NOT NULL,
    name_en VARCHAR(255),
    
    -- Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    contact_person VARCHAR(100),
    phone VARCHAR(20),
    email VARCHAR(255),
    address TEXT,
    country CHAR(2),
    
    -- Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©
    payment_terms ENUM('cash', 'net_7', 'net_15', 'net_30', 'net_60') NOT NULL,
    default_currency CHAR(3) NOT NULL DEFAULT 'SAR',
    lead_time_days INT,  -- Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
    min_order_quantity INT,  -- MOQ
    incoterms VARCHAR(10),  -- EXWØŒ FOBØŒ CIFØŒ DDP
    
    -- Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    rating DECIMAL(3,2),  -- 0-5
    on_time_delivery_pct DECIMAL(5,2),
    defect_rate_pct DECIMAL(5,2),
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM('active', 'inactive', 'blacklisted') NOT NULL DEFAULT 'active',
    
    -- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
    notes TEXT,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    INDEX idx_status (status),
    INDEX idx_rating (rating)
) ENGINE=InnoDB;
```

---

## 2. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ PO | Purchase Orders {#purchase-orders}

### **Ø¬Ø¯ÙˆÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ | Purchase Orders Table**

```sql
CREATE TABLE purchase_orders (
    po_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    po_no VARCHAR(20) UNIQUE NOT NULL,  -- PO-20250108-001
    
    supplier_id BIGINT NOT NULL,
    warehouse_id BIGINT NOT NULL,  -- Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    order_date DATETIME NOT NULL,
    expected_delivery_date DATE,
    approved_at DATETIME,
    closed_at DATETIME,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM(
        'draft',         -- Ù…Ø³ÙˆØ¯Ø©
        'submitted',     -- Ù…Ø±Ø³Ù„ Ù„Ù„Ù…ÙˆØ±Ø¯
        'approved',      -- Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡
        'partial',       -- Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø²Ø¦ÙŠ
        'completed',     -- Ù…ÙƒØªÙ…Ù„
        'cancelled'      -- Ù…Ù„ØºÙŠ
    ) NOT NULL DEFAULT 'draft',
    
    -- Ø§Ù„Ù…Ø¨Ø§Ù„Øº
    subtotal DECIMAL(12,2) NOT NULL,
    shipping_cost DECIMAL(12,2) DEFAULT 0.00,
    insurance_cost DECIMAL(12,2) DEFAULT 0.00,
    customs_cost DECIMAL(12,2) DEFAULT 0.00,
    other_costs DECIMAL(12,2) DEFAULT 0.00,
    total DECIMAL(12,2) NOT NULL,
    currency CHAR(3) NOT NULL,
    
    -- Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (Ø¥Ø°Ø§ Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
    exchange_rate DECIMAL(10,6),
    exchange_rate_date DATE,
    
    -- Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª
    created_by BIGINT NOT NULL,
    approved_by BIGINT,
    
    -- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
    notes TEXT,
    attachments JSON,  -- Ø±ÙˆØ§Ø¨Ø· Ù„Ù…Ù„ÙØ§Øª (Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø±ØŒ Ø¹Ù‚ÙˆØ¯)
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id),
    
    INDEX idx_supplier_status (supplier_id, status),
    INDEX idx_order_date (order_date),
    INDEX idx_expected_delivery (expected_delivery_date)
) ENGINE=InnoDB;
```

---

### **Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙˆØ¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ | PO Items Table**

```sql
CREATE TABLE purchase_order_items (
    po_item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    po_id BIGINT NOT NULL,
    variant_id BIGINT NOT NULL,
    
    -- Ø§Ù„ÙƒÙ…ÙŠØ§Øª
    quantity_ordered INT NOT NULL,
    quantity_received INT DEFAULT 0,
    quantity_remaining INT NOT NULL,  -- Ù…Ø­Ø³ÙˆØ¨
    
    -- Ø§Ù„ØªØ³Ø¹ÙŠØ±
    unit_cost DECIMAL(10,2) NOT NULL,  -- Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
    discount_per_unit DECIMAL(10,2) DEFAULT 0.00,
    net_unit_cost DECIMAL(10,2) NOT NULL,  -- Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
    line_total DECIMAL(12,2) NOT NULL,
    
    -- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø¨Ø¹Ø¯ ØªÙˆØ²ÙŠØ¹ Landed Cost)
    landed_cost_per_unit DECIMAL(10,2),
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    expected_delivery_date DATE,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM('pending', 'partial', 'completed', 'cancelled') NOT NULL DEFAULT 'pending',
    
    notes TEXT,
    
    FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id),
    FOREIGN KEY (variant_id) REFERENCES product_variants(variant_id),
    
    INDEX idx_po (po_id),
    INDEX idx_variant (variant_id),
    INDEX idx_status (status)
) ENGINE=InnoDB;
```

---

## 3. Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ASN | Inbound Shipments {#inbound-shipments}

### **Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© | Inbound Shipments Table**

```sql
CREATE TABLE inbound_shipments (
    shipment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    shipment_no VARCHAR(20) UNIQUE NOT NULL,  -- ASN-20250108-001
    
    po_id BIGINT NOT NULL,
    supplier_id BIGINT NOT NULL,
    warehouse_id BIGINT NOT NULL,
    
    -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†
    carrier VARCHAR(100),
    tracking_number VARCHAR(100),
    shipping_method ENUM('air', 'sea', 'land') NOT NULL,
    container_number VARCHAR(50),
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    shipped_date DATE,
    estimated_arrival DATE,  -- ETA
    actual_arrival DATE,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM(
        'pending',       -- ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ø­Ù†
        'in_transit',    -- ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚
        'customs',       -- ÙÙŠ Ø§Ù„Ø¬Ù…Ø§Ø±Ùƒ
        'arrived',       -- ÙˆØµÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        'receiving',     -- Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
        'completed'      -- Ù…ÙƒØªÙ…Ù„
    ) NOT NULL DEFAULT 'pending',
    
    -- Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª
    total_weight_kg DECIMAL(10,3),
    total_volume_m3 DECIMAL(10,3),
    package_count INT,
    
    notes TEXT,
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id),
    FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id),
    
    INDEX idx_po (po_id),
    INDEX idx_tracking (tracking_number),
    INDEX idx_status_eta (status, estimated_arrival)
) ENGINE=InnoDB;
```

---

## 4. Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ÙØ­Øµ GRN | Goods Receipt {#goods-receipt}

### **Ø¬Ø¯ÙˆÙ„ Ø¥Ø«Ø¨Ø§ØªØ§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | Goods Receipt Notes Table**

```sql
CREATE TABLE goods_receipts (
    grn_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    grn_no VARCHAR(20) UNIQUE NOT NULL,  -- GRN-20250108-001
    
    po_id BIGINT NOT NULL,
    shipment_id BIGINT,
    warehouse_id BIGINT NOT NULL,
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    received_date DATETIME NOT NULL,
    inspected_date DATETIME,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM('pending_inspection', 'inspected', 'posted') NOT NULL DEFAULT 'pending_inspection',
    
    -- Ø§Ù„Ù…Ø³ØªÙ„Ù…
    received_by BIGINT NOT NULL,
    inspected_by BIGINT,
    
    notes TEXT,
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id),
    FOREIGN KEY (shipment_id) REFERENCES inbound_shipments(shipment_id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id),
    
    INDEX idx_po (po_id),
    INDEX idx_received_date (received_date),
    INDEX idx_status (status)
) ENGINE=InnoDB;
```

---

### **Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… | GRN Items Table**

```sql
CREATE TABLE grn_items (
    grn_item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    grn_id BIGINT NOT NULL,
    po_item_id BIGINT NOT NULL,
    variant_id BIGINT NOT NULL,
    
    -- Ø§Ù„ÙƒÙ…ÙŠØ§Øª
    quantity_ordered INT NOT NULL,  -- Ù…Ù† PO
    quantity_received INT NOT NULL,  -- Ø§Ù„ÙØ¹Ù„ÙŠ
    quantity_accepted INT NOT NULL,  -- Ø¨Ø¹Ø¯ QC
    quantity_rejected INT DEFAULT 0,  -- Ù…Ø¹ÙŠØ¨/ØªØ§Ù„Ù
    
    -- Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©
    qc_status ENUM('pending', 'pass', 'fail', 'partial') NOT NULL DEFAULT 'pending',
    qc_notes TEXT,
    
    -- Ø§Ù„ØªÙƒÙ„ÙØ©
    unit_cost DECIMAL(10,2) NOT NULL,
    line_total DECIMAL(12,2) NOT NULL,
    
    -- Ø§Ù„Ù‚Ø±Ø§Ø±
    disposition ENUM(
        'accept',        -- Ù‚Ø¨ÙˆÙ„ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
        'reject',        -- Ø±ÙØ¶ RTV
        'rework',        -- Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø©
        'discount'       -- Ù‚Ø¨ÙˆÙ„ Ø¨Ø®ØµÙ…
    ),
    
    FOREIGN KEY (grn_id) REFERENCES goods_receipts(grn_id),
    FOREIGN KEY (po_item_id) REFERENCES purchase_order_items(po_item_id),
    FOREIGN KEY (variant_id) REFERENCES product_variants(variant_id),
    
    INDEX idx_grn (grn_id),
    INDEX idx_po_item (po_item_id),
    INDEX idx_qc_status (qc_status)
) ENGINE=InnoDB;
```

---

## 5. Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Landed Cost | Landed Cost {#landed-cost}

### **Ø¬Ø¯ÙˆÙ„ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ø­Ù† | Shipping Costs Table**

```sql
CREATE TABLE landed_costs (
    cost_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    po_id BIGINT NOT NULL,
    grn_id BIGINT,
    
    -- Ù†ÙˆØ¹ Ø§Ù„ØªÙƒÙ„ÙØ©
    cost_type ENUM(
        'shipping',      -- Ø´Ø­Ù†
        'insurance',     -- ØªØ£Ù…ÙŠÙ†
        'customs',       -- Ø¬Ù…Ø§Ø±Ùƒ
        'handling',      -- Ù…Ù†Ø§ÙˆÙ„Ø©
        'other'          -- Ø£Ø®Ø±Ù‰
    ) NOT NULL,
    
    -- Ø§Ù„Ù…Ø¨Ù„Øº
    amount DECIMAL(12,2) NOT NULL,
    currency CHAR(3) NOT NULL,
    
    -- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹
    allocation_method ENUM(
        'value',         -- Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
        'weight',        -- Ø­Ø³Ø¨ Ø§Ù„ÙˆØ²Ù†
        'volume',        -- Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¬Ù…
        'quantity',      -- Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ©
        'manual'         -- ÙŠØ¯ÙˆÙŠ
    ) NOT NULL DEFAULT 'value',
    
    -- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
    description VARCHAR(255),
    reference_no VARCHAR(100),  -- Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø­Ù† Ù…Ø«Ù„Ø§Ù‹
    
    created_at DATETIME NOT NULL,
    
    FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id),
    FOREIGN KEY (grn_id) REFERENCES goods_receipts(grn_id),
    
    INDEX idx_po (po_id),
    INDEX idx_type (cost_type)
) ENGINE=InnoDB;
```

---

### **Ø­Ø³Ø§Ø¨ Landed Cost | Calculate Landed Cost**

```sql
-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯
DELIMITER //
CREATE PROCEDURE sp_calculate_landed_cost(IN p_grn_id BIGINT)
BEGIN
    DECLARE v_total_value DECIMAL(12,2);
    DECLARE v_total_additional_costs DECIMAL(12,2);
    
    -- 1. Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯
    SELECT SUM(quantity_accepted * unit_cost)
    INTO v_total_value
    FROM grn_items
    WHERE grn_id = p_grn_id;
    
    -- 2. Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    SELECT SUM(amount)
    INTO v_total_additional_costs
    FROM landed_costs
    WHERE grn_id = p_grn_id;
    
    -- 3. ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©)
    UPDATE grn_items gi
    JOIN (
        SELECT 
            grn_item_id,
            unit_cost + (
                (quantity_accepted * unit_cost / v_total_value) * 
                v_total_additional_costs / quantity_accepted
            ) AS calculated_landed_cost
        FROM grn_items
        WHERE grn_id = p_grn_id
    ) calc ON gi.grn_item_id = calc.grn_item_id
    SET gi.landed_cost_per_unit = calc.calculated_landed_cost;
    
    -- 4. ØªØ­Ø¯ÙŠØ« PO items
    UPDATE purchase_order_items poi
    JOIN grn_items gi ON poi.po_item_id = gi.po_item_id
    SET poi.landed_cost_per_unit = gi.landed_cost_per_unit
    WHERE gi.grn_id = p_grn_id;
    
END//
DELIMITER ;
```

---

## 6. Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø«Ù„Ø§Ø«ÙŠØ© | 3-Way Matching {#three-way-matching}

### **Ø¬Ø¯ÙˆÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† | Supplier Invoices Table**

```sql
CREATE TABLE supplier_invoices (
    invoice_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    invoice_no VARCHAR(50) UNIQUE NOT NULL,
    
    supplier_id BIGINT NOT NULL,
    po_id BIGINT NOT NULL,
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    invoice_date DATE NOT NULL,
    due_date DATE NOT NULL,
    
    -- Ø§Ù„Ù…Ø¨Ø§Ù„Øº
    subtotal DECIMAL(12,2) NOT NULL,
    tax_amount DECIMAL(12,2) DEFAULT 0.00,
    total DECIMAL(12,2) NOT NULL,
    currency CHAR(3) NOT NULL,
    
    -- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    match_status ENUM(
        'pending',       -- ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        'matched',       -- Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹
        'variance',      -- ÙØ±ÙˆÙ‚Ø§Øª Ø¶Ù…Ù† Ø§Ù„ØªØ­Ù…Ù„
        'exception'      -- Ø§Ø³ØªØ«Ù†Ø§Ø¡ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©
    ) NOT NULL DEFAULT 'pending',
    
    -- Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª
    quantity_variance INT DEFAULT 0,
    price_variance DECIMAL(12,2) DEFAULT 0.00,
    variance_notes TEXT,
    
    -- Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
    payment_status ENUM('unpaid', 'partial', 'paid') NOT NULL DEFAULT 'unpaid',
    paid_amount DECIMAL(12,2) DEFAULT 0.00,
    paid_at DATETIME,
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id),
    FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id),
    
    INDEX idx_supplier (supplier_id),
    INDEX idx_po (po_id),
    INDEX idx_match_status (match_status),
    INDEX idx_due_date (due_date)
) ENGINE=InnoDB;
```

---

### **Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø«Ù„Ø§Ø«ÙŠØ© | 3-Way Match Procedure**

```sql
-- Ù…Ø·Ø§Ø¨Ù‚Ø© PO â†” GRN â†” Invoice
DELIMITER //
CREATE PROCEDURE sp_three_way_match(IN p_invoice_id BIGINT)
BEGIN
    DECLARE v_po_total DECIMAL(12,2);
    DECLARE v_grn_total DECIMAL(12,2);
    DECLARE v_invoice_total DECIMAL(12,2);
    DECLARE v_variance DECIMAL(12,2);
    DECLARE v_tolerance DECIMAL(5,2) DEFAULT 0.05;  -- ØªØ­Ù…Ù„ 5%
    
    -- 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¬Ø§Ù…ÙŠØ¹
    SELECT total INTO v_invoice_total
    FROM supplier_invoices
    WHERE invoice_id = p_invoice_id;
    
    SELECT SUM(quantity_ordered * net_unit_cost) INTO v_po_total
    FROM purchase_order_items
    WHERE po_id = (SELECT po_id FROM supplier_invoices WHERE invoice_id = p_invoice_id);
    
    SELECT SUM(quantity_accepted * unit_cost) INTO v_grn_total
    FROM grn_items gi
    JOIN goods_receipts gr ON gi.grn_id = gr.grn_id
    WHERE gr.po_id = (SELECT po_id FROM supplier_invoices WHERE invoice_id = p_invoice_id);
    
    -- 2. Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚
    SET v_variance = ABS(v_invoice_total - v_grn_total);
    
    -- 3. ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    IF v_variance = 0 THEN
        UPDATE supplier_invoices
        SET match_status = 'matched'
        WHERE invoice_id = p_invoice_id;
        
    ELSEIF v_variance / v_grn_total <= v_tolerance THEN
        UPDATE supplier_invoices
        SET match_status = 'variance',
            price_variance = v_variance,
            variance_notes = CONCAT('ÙØ±Ù‚ Ø¶Ù…Ù† Ø§Ù„ØªØ­Ù…Ù„: ', v_variance)
        WHERE invoice_id = p_invoice_id;
        
    ELSE
        UPDATE supplier_invoices
        SET match_status = 'exception',
            price_variance = v_variance,
            variance_notes = CONCAT('ÙØ±Ù‚ ÙƒØ¨ÙŠØ± ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©: ', v_variance)
        WHERE invoice_id = p_invoice_id;
    END IF;
    
END//
DELIMITER ;
```

---

## 7. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† RTV | Return to Vendor {#return-to-vendor}

### **Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† | RTV Table**

```sql
CREATE TABLE return_to_vendor (
    rtv_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rtv_no VARCHAR(20) UNIQUE NOT NULL,  -- RTV-20250108-001
    
    supplier_id BIGINT NOT NULL,
    grn_id BIGINT NOT NULL,
    
    -- Ø§Ù„Ø³Ø¨Ø¨
    reason ENUM(
        'defective',     -- Ù…Ø¹ÙŠØ¨
        'wrong_item',    -- ØµÙ†Ù Ø®Ø§Ø·Ø¦
        'damaged',       -- ØªØ§Ù„Ù
        'excess',        -- ÙØ§Ø¦Ø¶
        'other'          -- Ø£Ø®Ø±Ù‰
    ) NOT NULL,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    status ENUM(
        'requested',     -- ØªÙ… Ø§Ù„Ø·Ù„Ø¨
        'approved',      -- Ù…ÙˆØ§ÙÙ‚
        'shipped',       -- ØªÙ… Ø§Ù„Ø´Ø­Ù† Ù„Ù„Ù…ÙˆØ±Ø¯
        'credited',      -- ØªÙ… Ø§Ù„Ø¥Ø¦ØªÙ…Ø§Ù†
        'closed'         -- Ù…ØºÙ„Ù‚
    ) NOT NULL DEFAULT 'requested',
    
    -- Ø§Ù„Ù…Ø¨Ø§Ù„Øº
    total_value DECIMAL(12,2) NOT NULL,
    credit_note_no VARCHAR(50),  -- Ø±Ù‚Ù… Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØµÙ…
    credit_amount DECIMAL(12,2),
    
    -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    requested_date DATETIME NOT NULL,
    shipped_date DATE,
    credited_date DATE,
    
    notes TEXT,
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (supplier_id) REFERENCES suppliers(supplier_id),
    FOREIGN KEY (grn_id) REFERENCES goods_receipts(grn_id),
    
    INDEX idx_supplier (supplier_id),
    INDEX idx_grn (grn_id),
    INDEX idx_status (status)
) ENGINE=InnoDB;
```

---

## 8. Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ | Reorder Rules {#reorder-rules}

### **Ø¬Ø¯ÙˆÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ | Reorder Rules Table**

```sql
CREATE TABLE reorder_rules (
    rule_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    variant_id BIGINT UNIQUE NOT NULL,
    warehouse_id BIGINT NOT NULL,
    
    -- Ù†Ù‚Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨
    reorder_point INT NOT NULL,  -- Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯
    
    -- ÙƒÙ…ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨
    reorder_quantity INT NOT NULL,  -- ÙƒÙ… Ù†Ø·Ù„Ø¨
    
    -- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¢Ù…Ù†
    safety_stock INT NOT NULL,  -- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    
    -- Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯
    lead_time_days INT NOT NULL,
    
    -- Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…ÙØ¶Ù„
    preferred_supplier_id BIGINT,
    
    -- Ø§Ù„Ø­Ø§Ù„Ø©
    is_active BOOLEAN DEFAULT TRUE,
    
    last_calculated_at DATETIME,
    
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    FOREIGN KEY (variant_id) REFERENCES product_variants(variant_id),
    FOREIGN KEY (warehouse_id) REFERENCES warehouses(warehouse_id),
    FOREIGN KEY (preferred_supplier_id) REFERENCES suppliers(supplier_id),
    
    INDEX idx_variant_warehouse (variant_id, warehouse_id),
    INDEX idx_active (is_active)
) ENGINE=InnoDB;
```

---

### **Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ | Reorder Monitoring**

```sql
-- Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨
SELECT 
    rr.variant_id,
    pv.sku,
    pv.name_ar,
    ss.available_to_promise AS current_stock,
    rr.reorder_point,
    rr.reorder_quantity,
    rr.preferred_supplier_id,
    s.name_ar AS supplier_name,
    rr.lead_time_days
FROM reorder_rules rr
JOIN product_variants pv ON rr.variant_id = pv.variant_id
JOIN stock_snapshot ss ON rr.variant_id = ss.variant_id 
    AND rr.warehouse_id = ss.warehouse_id
LEFT JOIN suppliers s ON rr.preferred_supplier_id = s.supplier_id
WHERE rr.is_active = TRUE
  AND ss.available_to_promise <= rr.reorder_point
ORDER BY ss.available_to_promise ASC;
```

---

## ğŸ”— **Ø§Ù„ØªÙ†Ù‚Ù„ | Navigation**

[â† Ø§Ù„Ø³Ø§Ø¨Ù‚: 10. Ù‚Ø§Ø¦Ù…Ø© Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª | Previous: Best Practices](10_Best_Practices.md)

[Ø§Ù„ØªØ§Ù„ÙŠ: 12. Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ | Next: Integration Services â†’](12_Integration_Services.md)

[ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ÙÙ‡Ø±Ø³ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | Back to Database Index](index.md)

---

**Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© | Document Version**: 1.0  
**Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« | Last Updated**: 2025-01-08  
**Ø§Ù„Ø­Ø§Ù„Ø© | Status**: âœ… Ù…ÙƒØªÙ…Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†ØªØ§Ø¬ | Complete and Production-Ready
