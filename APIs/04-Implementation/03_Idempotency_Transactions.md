# 03. ุนุฏู ุงูุชูุฑุงุฑ ูุงููุนุงููุงุช | Idempotency & Transactions

## ๐ฏ **ูุธุฑุฉ ุนุงูุฉ | Overview**

ุถูุงู ุนุฏู ุชูุฑุงุฑ ุชูููุฐ ุงูุนูููุงุช ุงูุญุณุงุณุฉ ูุฅุฏุงุฑุฉ ุงููุนุงููุงุช ุจุดูู ุขูู.

**ุงููุฏู | Purpose**: ููุน ุงูุชูููุฐ ุงูููุฑุฑ ููุนูููุงุช  
**ุงูุฌูููุฑ | Audience**: ูุทูุฑู Backend  
**ุงููุชุทูุจุงุช | Prerequisites**: ููู [ุฃุณุงููุจ HTTP](../01-Core-Principles/03_HTTP_Methods_Status.md)

---

## ๐ **ุฌุฏูู ุงููุญุชููุงุช | Table of Contents**

1. [ูุง ูู Idempotency](#ูุง-ูู-idempotency)
2. [ุขููุฉ ุงูุชูููุฐ](#ุขููุฉ-ุงูุชูููุฐ)
3. [Idempotency-Key](#idempotency-key)
4. [ุฃูุซูุฉ ุนูููุฉ](#ุฃูุซูุฉ-ุนูููุฉ)
5. [ุฃูุถู ุงูููุงุฑุณุงุช](#ุฃูุถู-ุงูููุงุฑุณุงุช)

---

## 1๏ธโฃ ูุง ูู Idempotency | What is Idempotency {#ูุง-ูู-idempotency}

### **ุงูุชุนุฑูู**
ุนูููุฉ **Idempotent** = ุชูููุฐูุง ุนุฏุฉ ูุฑุงุช ููุชุฌ ููุณ ุงูุฃุซุฑ ูุชูููุฐูุง ูุฑุฉ ูุงุญุฏุฉ.

### **ููุงุฐุง ูุญุชุงุฌูุ**
```
ุณููุงุฑูู: ุฅูุดุงุก ุทูุจ

1. ุงูุนููู ูุฑุณู POST /v1/orders
2. ุงูุฎุงุฏู ูุนุงูุฌ ููููุดุฆ ุงูุทูุจ
3. ุงูุงุณุชุฌุงุจุฉ ุชูููุฏ ูู ุงูุดุจูุฉ โ
4. ุงูุนููู ููุนูุฏ ุงููุญุงููุฉ ุชููุงุฆููุง
5. ุจุฏูู Idempotency: ุทูุจ ููุฑุฑ โโ
   ูุน Idempotency: ููุณ ุงูุทูุจ ุงูุฃุตูู โ
```

---

### **ุฌุฏูู Idempotency ููุฃุณุงููุจ**

| ุงูุฃุณููุจ | Idempotentุ | ุดุฑุญ |
|---------|------------|-----|
| **GET** | โ ูุนู | ูุฑุงุกุฉ ููุท - ููุณ ุงููุชูุฌุฉ ุฏุงุฆููุง |
| **POST** | โ ูุง | ูููุดุฆ ููุฑุฏ ุฌุฏูุฏ ูู ูุฑุฉ |
| **PUT** | โ ูุนู | ุงุณุชุจุฏุงู ูุงูู - ููุณ ุงููุชูุฌุฉ |
| **PATCH** | โ๏ธ ูุนุชูุฏ | ุฅุฐุง ุตููู ุจุดูู ุตุญูุญ |
| **DELETE** | โ ูุนู | ุญุฐู ูุฑุชูู = ููุณ ุงููุชูุฌุฉ |

---

## 2๏ธโฃ ุขููุฉ ุงูุชูููุฐ | Implementation Mechanism {#ุขููุฉ-ุงูุชูููุฐ}

### **ูุฎุทุท ุงูุชุฏูู**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ุงุณุชูุงู ุงูุทูุจ                            โ
โ    POST /v1/orders                          โ
โ    Idempotency-Key: abc-123                 โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. ุงูุจุญุซ ุนู ุงูููุชุงุญ ูู Cache/DB            โ
โ    SELECT * FROM idempotency_keys           โ
โ    WHERE key = 'abc-123'                    โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
         โโโโโโโโโโโดโโโโโโโโโโ
         โ                   โ
    ุบูุฑ ููุฌูุฏ             ููุฌูุฏ
         โ                   โ
         โ                   โ
โโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ
โ 3a. ุฅูุดุงุก ุณุฌู  โ  โ 3b. ูุญุต ุงูุจุตูุฉ      โ
โ     in_progress โ  โ     fingerprint       โ
โโโโโโโโโโฌโโโโโโโโโ  โโโโโโโโฌโโโโโโโโโโโโโโโโ
         โ                  โ
         โ            โโโโโโโดโโโโโโโ
โโโโโโโโโโโโโโโโโโโ  โ            โ
โ 4a. ุชูููุฐ       โ  ููุณ     ูุฎุชูู
โ     ุงูุนูููุฉ     โ  โ            โ
โโโโโโโโโโฌโโโโโโโโโ  โ            โ
         โ      โโโโโโโโโโ  โโโโโโโโโโโโโ
         โ      โ ุฅุฑุฌุงุน โ  โ 409       โ
         โ      โ ููุณ   โ  โ Conflict  โ
         โ      โ ุงูุฑุฏ  โ  โโโโโโโโโโโโโ
         โ      โโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโ
โ 5. ุญูุธ ุงููุชูุฌุฉ โ
โ    succeeded    โ
โ    + response   โ
โโโโโโโโโโโโโโโโโโโ
```

---

## 3๏ธโฃ Idempotency-Key Header {#idempotency-key}

### **ุชูุณูู ุงูููุชุงุญ**
```
Idempotency-Key: <UUIDv4>

ูุซุงู:
Idempotency-Key: c5a8bd76-b6d9-4c49-8e1a-1b2c3d4e5f6g
```

### **ููุงุนุฏ ุงูููุชุงุญ**
- โ UUIDv4 (ููุตู ุจู)
- โ ูุฑูุฏ ููู ุนูููุฉ "ููุฉ ุนูู"
- โ ููููุฏู ุงูุนููู (ูููุณ ุงูุฎุงุฏู)
- โ ูุณุชูู ุนู ุงููุณุชุฎุฏู (ููุณ ุงูููุชุงุญ ูููุณ ุงูุนูููุฉ)

---

### **ุฌุฏูู idempotency_keys**

```sql
CREATE TABLE idempotency_keys (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    
    -- ุงูููุชุงุญ ุงููุฑูุฏ
    idempotency_key VARCHAR(100) NOT NULL,
    user_id BIGINT UNSIGNED NULL,
    
    -- ุจุตูุฉ ุงูุทูุจ (ููุชุญูู ูู ุงูุชุทุงุจู)
    request_fingerprint_sha256 CHAR(64) NOT NULL,
    -- fingerprint = hash(method + path + body + user_id)
    
    -- ุงูุญุงูุฉ
    status ENUM('in_progress', 'succeeded', 'failed') NOT NULL,
    
    -- ุงูุงุณุชุฌุงุจุฉ ุงููุฎุฒูุฉ
    response_status SMALLINT NULL,
    response_body_json JSON NULL,
    
    -- ุงูุงูุชูุงุก
    expires_at DATETIME NOT NULL,
    
    -- ุงูุทูุงุจุน ุงูุฒูููุฉ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ุงูููุงุฑุณ
    UNIQUE KEY uk_key_user (idempotency_key, user_id),
    INDEX idx_expires (expires_at),
    INDEX idx_status (status)
);
```

---

## 4๏ธโฃ ุฃูุซูุฉ ุนูููุฉ | Practical Examples {#ุฃูุซูุฉ-ุนูููุฉ}

### **ูุซุงู 1: ุฅูุดุงุก ุทูุจ**

#### **ุงูุทูุจ ุงูุฃูู**
```http
POST /v1/orders
Authorization: Bearer <token>
Idempotency-Key: c5a8bd76-b6d9-4c49-8e1a-1b2c3d4e5f6g
Content-Type: application/json

{
  "customer_id": 789,
  "items": [
    { "variant_id": 123, "quantity": 2 }
  ],
  "payment_method": "cod"
}

โถ ุงูุงุณุชุฌุงุจุฉ

HTTP/1.1 201 Created
Location: /v1/orders/ORD-20250108-00123
Idempotent-Replayed: false

{
  "id": "ORD-20250108-00123",
  "status": "pending",
  "total": 702.70,
  "created_at": "2025-01-08T12:00:00Z"
}
```

---

#### **ุงูุทูุจ ุงูุซุงูู (ุฅุนุงุฏุฉ ูุญุงููุฉ - ููุณ ุงูุจูุงูุงุช)**
```http
POST /v1/orders
Idempotency-Key: c5a8bd76-b6d9-4c49-8e1a-1b2c3d4e5f6g
[ููุณ Body]

โถ ุงูุงุณุชุฌุงุจุฉ

HTTP/1.1 201 Created
Location: /v1/orders/ORD-20250108-00123
Idempotent-Replayed: true  โ ุชู ุฅุนุงุฏุฉ ุงูุฑุฏ ุงููุญููุธ

{
  "id": "ORD-20250108-00123",  โ ููุณ ุงูุทูุจ
  "status": "pending",
  "total": 702.70,
  "created_at": "2025-01-08T12:00:00Z"
}
```

---

#### **ุงูุทูุจ ุงูุซุงูุซ (ููุณ ุงูููุชุงุญุ ุจูุงูุงุช ูุฎุชููุฉ)**
```http
POST /v1/orders
Idempotency-Key: c5a8bd76-b6d9-4c49-8e1a-1b2c3d4e5f6g
{
  "customer_id": 999,  โ ูุฎุชูู!
  "items": [...]
}

โถ ุงูุงุณุชุฌุงุจุฉ

HTTP/1.1 409 Conflict

{
  "error": {
    "code": "E4001",
    "message": "Idempotency key conflict",
    "details": "Key already used for different request body"
  }
}
```

---

### **ูุซุงู 2: ุงูุฏูุน**

```http
POST /v1/payments
Idempotency-Key: payment-xyz-789
{
  "order_id": "ORD-123",
  "amount": 702.70,
  "method": "online"
}

# ุงูุฃูููุฉ: ููุน ุงูุฎุตู ุงูููุฑุฑ ูู ุงูุจุทุงูุฉ
```

---

## 5๏ธโฃ ุฃูุถู ุงูููุงุฑุณุงุช | Best Practices {#ุฃูุถู-ุงูููุงุฑุณุงุช}

### โ **ุงูุนู | Do**

1. **ุงุณุชุฎุฏู Idempotency-Key ููุนูููุงุช ุงูุญุณุงุณุฉ**
   ```
   โ ุฅูุดุงุก ุทูุจ
   โ ูุนุงูุฌุฉ ุฏูุน
   โ ุชุทุจูู ูุณููุฉ
   โ ุฅูุดุงุก ุงุณุชุฑุฏุงุฏ
   ```

2. **ุงุญุณุจ ุจุตูุฉ ุงูุทูุจ**
   ```php
   $fingerprint = hash('sha256', 
       $method . $path . json_encode($body) . $userId
   );
   ```

3. **TTL ููุงุณุจ**
   ```
   โ ุนูููุงุช ูุงููุฉ: 72 ุณุงุนุฉ
   โ ุนูููุงุช ุนุงุฏูุฉ: 24 ุณุงุนุฉ
   ```

4. **ุชุฎุฒูู ุงูุงุณุชุฌุงุจุฉ ูุงููุฉ**
   ```
   response_status + response_body
   ```

---

### โ **ูุง ุชูุนู | Don't**

1. **ูุง ุชุชุฌุงูู ุงูููุชุงุญ**
   ```php
   โ if (empty($idempotencyKey)) {
        // continue anyway
      }
   
   โ if (empty($idempotencyKey)) {
        return 400; // ูุทููุจ
      }
   ```

2. **ูุง ุจุตูุฉ ุจุฏูู user_id**
   ```
   โ hash(body only)
   โ hash(body + user_id)
   ```

---

## โ **ูุงุฆูุฉ ุงูุชุญูู | Checklist**

### **ุนูุฏ ุชูููุฐ Idempotency**
- [ ] ุฌุฏูู idempotency_keys ุฌุงูุฒ
- [ ] Idempotency-Key ุฅูุฒุงูู ููุนูููุงุช ุงูุญุณุงุณุฉ
- [ ] ุญุณุงุจ ูุชุฎุฒูู fingerprint
- [ ] TTL ููุงุณุจ
- [ ] ุฑุฏ Idempotent-Replayed
- [ ] 409 ุนูุฏ ุชุนุงุฑุถ ุงูุจุตูุฉ
- [ ] ูุฑุงูุจุฉ ูุนุฏู ุงูุชูุฑุงุฑ

---

## ๐ **ุงูุชููู | Navigation**

[โ ุงูุณุงุจู: ุงูุชุฑููู ูุงูุชุตููุฉ | Previous: Pagination & Filtering](02_Pagination_Filtering_Sorting.md)

[ุงูุชุงูู: ุงูุชุญูู ูุงููุฎุทุทุงุช | Next: Validation & Schemas โ](04_Validation_Schemas.md)

[๐ ุงูุนูุฏุฉ ููููุฑุณ | Back to Index](../index.md)

---

**ุงูุฅุตุฏุงุฑ | Version**: 1.0  
**ุขุฎุฑ ุชุญุฏูุซ | Last Updated**: 2025-01-08  
**ุงูุญุงูุฉ | Status**: โ ูุฑุงุฌุน ููุนุชูุฏ | Reviewed and Approved